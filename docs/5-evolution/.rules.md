# AI辅助DDD软件工程模板：Evolution阶段规则

## 阶段概述与定位
此目录对应DDD的演进与维护阶段：处理软件持续迭代、变更管理和优化（Evolution Phase）。焦点是基于全流程输出，记录迭代设计、追踪跨目录变更（e.g., 模型重构）、分析原因，并生成优化建议，确保文档和系统保持有效性、一致性和可演进性。这演进传统软件工程的“维护、回顾与重构”实践，在AI时代通过自动化历史分析和预测，减少“技术债务”和设计漂移。

- **思维方式（Agent专用）**：反思、数据驱动、预测导向。在处理前，进行chain-of-thought分析：评估变更影响、追踪历史原因、预测未来风险（e.g., '此模型变更可能导致测试覆盖下降10%'）。
- **Agent行为模式**：直接执行演进任务：1. 分析输入/历史；2. 生成变更记录/报告；3. 建议优化和自验证。无人类引导循环——如果不确定，输出备选方案并标记；严格约束：所有记录包括变更原因（why）、影响和引用，确保文档有效性。
- **协作原则（继承全局，调整为AI自治）**：AI基于输入/GIt历史直接生成；输出可供人类决策，但Agent自治处理分析。
- **参考输入**：全流程文档（e.g., 相对路径：../2-modeling/aggregates/order_aggregate.yaml）；Git历史、指标日志。
- **产出文档类型**：变更日志（.md）、报告（.yaml）。这些文档服务于整体模板：闭环反馈，保持文档活性和系统健康。
- **目标服务**：持续维护文档有效性（e.g., 自动检测过时模型）；记录迭代设计/变更原因，支持知识沉淀和未来演进。

人类开发者：使用此目录触发AI分析迭代，提供新需求/GIt diff；审阅输出以指导重构。AI工具：严格遵守规则，直接执行任务，确保反思性演进。

## 目录用法指南
- **文件创建**：新增日志或报告文件（e.g., changes/2025-08-11-v1.1/change_log.md），AI根据规则填充。
- **子目录建议**：添加changes/（时间序变更记录）、reports/（优化总结），继承本规则以细化（e.g., changes/ai_rules.md强调ADR格式）。
- **跨阶段引用**：必须链接受影响文件（e.g., [../2-modeling/...diff]），记录变更原因；使用Git集成追踪历史。
- **验证**：记录必须覆盖原因/影响；如果文档不一致，AI建议同步更新。

## 阶段规则定义（JSON-like，供AI解析，继承全局）
{
  "phase": "evolution",
  "inherited_from": "全局规则（合并constraints、output_format_defaults）",
  "mindset": "反思预测：分析历史原因、当前变更、未来影响；优先'why' over 'what'",
  "agent_behavior": {
    "execution_mode": "自治演进：无引导；输出结构：1. 变更分析；2. 生成记录/报告；3. 优化建议 + 自验证",
    "pre_generation_step": "Chain-of-thought：追踪变更（from Git/diff）、原因（业务驱动？）、影响（e.g., 边界调整）",
    "constraints": [
      "文档有效性：记录所有跨目录变更（e.g., modeling更新），包括diff、原因（ADR风格）",
      "DDD演进：评估对聚合/上下文的影响，确保不变式保持",
      "经验补充：追踪指标（e.g., 模型一致性>90%）；预测风险（e.g., 重构成本）"
    ],
    "response_style": "叙述+结构化：使用时间线视图；包含引用和diff嵌入"
  },
  "prompt_template": "基于{user_input}、Git历史和参考{input_docs}，执行演进：分析变更，生成{output_type}，记录原因并建议优化。",
  "reference_inputs": [
    "新需求/变更diff",
    "全流程文档 + Git历史"
  ],
  "output_formats": {
    "change_log": "Markdown：# 迭代v1.1\n## 变更：...\n## 原因：...\n## 引用：[path] (diff:...)",
    "evolution_report": "YAML：{iteration: 'v1.1', changes: [...], metrics: {consistency: 95%}, suggestions: [...] }"
  },
  "goals_served": [
    "保持文档有效性，通过记录迭代设计/变更原因",
    "支持DDD演进：预测重构，减少漂移"
  ],
  "validation_rules": "自检查：原因完整、引用准确；一致性>90%；如果失效，输出'警告：{issue}'"
}

## 示例Agent执行输出
- **人类输入**： "记录v1.1迭代：更新OrderAggregate添加tenant_id。"
- **AI响应（直接生成）**：
  1. **变更分析**：
     - 历史：从Git commit abc123追踪，原模型单租户。
     - 原因：业务需求（多租户支持），源于M2反馈；影响：增强隔离，但需更新测试。
  2. **生成记录**（e.g., change_log.md）：
     ```
     # 迭代v1.1 - 多租户增强
     ## 新设计/变更
     - 更新OrderAggregate：添加tenant_id字段。
     ## 原因
     - 业务驱动：支持分域委派（参考需求日志）；避免单租户瓶颈。
     - 决策：ADR-001 - 选择事件驱动隔离而非共享DB。
     ## 引用与diff
     - [../2-modeling/aggregates/order_aggregate.yaml] (diff: + tenant_id: string)
     ## 影响
     - 测试：需扩展集成测试；预测风险：兼容性bug（概率20%）。
     ```
  3. **优化建议 + 自验证**： "建议：灰度重构；验证：文档一致性95%，原因覆盖完整。"

## 维护与扩展提示
- **继承全局**：如果冲突，本地规则优先（e.g., 覆盖格式以添加指标）。
- **AI自我检查**：输出末尾添加"此记录维护了有效性？[是/否，为什么]"。
- **人类提示**：如果需要扩展，输入"分析{change}影响"；定期运行以同步文档。
- **子目录扩展**：为changes/添加规则，聚焦时间序（e.g., 自动从Git拉取diff）。

此规则确保AI自治维护DDD演进。如果您是AI，启动执行模式；如果您是人类，准备输入以触发分析！
