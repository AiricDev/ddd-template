## **个人可信网络基础层协议**

**草案版本 0.2**

**作者:** Leric Zhang
**联系方式:** leric.zhang@gmail.com
**日期:** August 4, 2025

**备忘录状态**

本文档是个人可信网络（Personal Trusted Mesh）基础层协议的设计规范草案，旨在促进讨论和完善。本文档的分发不受限制。

**摘要**

本文档定义了个人可信网络的基础层协议。这是一个为小型、可信的个人设备网络设计的、安全的端到端加密（E2EE）通信框架。该协议为已认证设备间的任意数据载荷提供通用传输，确保通信的机密性、完整性以及前向/后向安全。

本协议的设计已从早期的自定义加密机制演进为采用标准的**双棘轮算法（Double Ratchet Algorithm）**，并推荐使用经过审计的`vodozemac` Rust库作为参考实现。因此，本文档的重点将从加密细节转向协议的**功能架构、设备生命周期管理（配置与撤销）以及扩展后的威胁模型**。协议假定用户自备MQTT代理（BYOB模型），所有安全机制均在客户端通过E2EE强制执行。

### **1. 引言**

随着用户个人设备生态（如桌面电脑、手机、平板）的不断扩展，设备间实时、安全的数据交换需求日益增长。本协议旨在解决这一问题，避免依赖可能引入隐私风险和单点故障的第三方云服务。

本协议的核心是定义一个健壮的、模块化的系统架构，该架构遵循**整洁架构（Clean Architecture）**原则，将加密核心、应用逻辑和外部接口（如网络和存储）清晰分离。

**1.1. 需求语言**

本文档中的关键词 "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", 和 "OPTIONAL" 应遵从 RFC 2119 的解释。

**1.2. 假设与范围**

*   **可信小网络**: 本协议专为由单一用户拥有的少量设备（如2-10台）设计，设备间通过显式配对建立信任。
*   **威胁模型**: 防御被动窃听者、主动网络攻击者（如公共Wi-Fi上的中间人攻击）和被攻破的MQTT代理。扩展后的威胁模型还将覆盖**设备配置过程中的攻击**和**不安全的设备移除**。
*   **范围之外**:
    *   **内部威胁**: 一个已被信任但其软件被恶意代码感染的设备所带来的风险，不在当前版本的考虑范围内。
    *   **流量分析**: 攻击者通过分析加密流量的元数据（如通信频率、消息大小）来推断用户行为的威胁，暂不处理。
    *   高层应用逻辑、用户界面和MQTT代理的管理。

### **2. 系统架构概述**

为了实现一个高内聚、低耦合的系统，协议的实现 **SHOULD** 遵循整洁架构原则，分为以下几个层次，依赖关系严格由外向内：

1.  **核心实体层 (Entities)**: 包含系统的核心业务对象，主要由`vodozemac`库提供的加密实体（如`Account`, `Session`）构成。
2.  **用例层 (Use Cases)**: 包含系统的核心业务逻辑，如设备配置、设备撤销、消息收发等。该层定义了外部依赖的接口（Ports）。
3.  **接口适配器层 (Interface Adapters)**: 实现用例层定义的接口。例如，实现持久化存储的`Keystore`和实现网络通信的`MQTT Transport`。
4.  **框架与驱动层 (Frameworks & Drivers)**: 最外层的具体实现，如`vodozemac`库、MQTT客户端库、操作系统文件系统等。

### **3. 设备生命周期管理**

**3.1. 设备配置 (Provisioning)**

设备配置是将一个新设备安全地加入到可信网络中的过程。

1.  **初始化**: 新设备（设备B）首次启动时，**MUST** 生成一个长期的身份密钥对（在`vodozemac`中由`Account`对象管理）。
2.  **发起邀请**: 一个已在网络中的可信设备（设备A），**MUST** 生成一个“邀请”。该邀请 **SHOULD** 包含设备A的公开身份密钥，并以**带外（Out-of-Band）**方式（如显示二维码）传递给设备B。
3.  **接受邀请与会话建立**: 设备B通过安全信道（如摄像头扫描）接收邀请后，**MUST** 使用该信息与设备A建立一个初始的加密会话（`Session`）。此过程由`vodozemac`的会话创建机制保证安全。
4.  **网络同步**: 设备A和B建立会话后，设备A **SHOULD** 通知网络中所有其他设备，以便它们也与设备B建立会话。

**3.2. 设备撤销 (Revocation)**

当一个设备丢失、被盗或退役时，必须将其从可信网络中安全移除。

1.  **发起撤销**: 由用户在一个受信任的设备上发起撤销命令，指定要移除的设备ID。
2.  **广播通知**: 发起设备 **MUST** 向网络中所有**其他剩余的**可信设备广播一条经过签名的“撤销通知”控制消息。
3.  **执行撤销**: 收到通知的设备 **MUST** 验证签名的有效性，然后 **MUST** 从其本地存储中删除与被撤销设备相关的所有会话状态。
4.  **完成**: 此后，任何来自被撤销设备的消息都将因为没有匹配的会话而被拒绝，从而实现了**前向保密**——被撤销的设备无法解密未来的任何消息。

### **4. 加密与会话管理**

本协议的端到端加密机制 **MUST** 基于**双棘轮算法**。

*   **实现**: 实现 **MUST** 使用`vodozemac` Rust库，它提供了对Olm/Megolm协议（双棘轮算法的一种实现）的经过审计的支持。所有关于密钥派生、对称/非对称棘轮、消息密钥生成和加密原语（X25519, Ed25519, AES-256）的细节，均遵循`vodozemac`的实现。
*   **状态持久化**: 每个设备 **MUST** 负责持久化存储其自身的`Account`对象以及与其他设备建立的所有`Session`对象。存储机制必须能防止未经授权的访问。

#### **5. 消息格式与传输**

*   **载荷 (Payload)**: `vodozemac`加密后的二进制数据块。
*   **传输 (Transport)**: 加密载荷 **MUST** 通过MQTT协议进行传输。
*   **MQTT 主题 (Topic)**: 消息 **SHOULD** 被发布到以接收者设备ID命名的特定主题上，格式为 `/mesh/{recipient_device_id}`。每个设备客户端 **MUST** 订阅其自身的设备ID主题以接收消息。

### **6. 安全考量（扩展威胁模型）**

除了1.2节中提到的基本威胁外，本协议还考虑并应对以下威胁：

*   **中间人攻击 (设备配置阶段)**
    *   **威胁**: 在设备配置时，攻击者可能拦截“邀请”并替换为自己的公钥，从而将恶意设备伪装成合法设备加入网络。
    *   **解决方案**: 邀请的传递 **MUST** 通过安全的带外信道完成。例如，用户通过肉眼比对设备B扫描二维码后显示的设备A的身份指纹（或一个简短的认证字符串），以确认其真实性。

*   **不安全的设备移除 (“垃圾桶攻击”)**
    *   **威胁**: 用户可能直接丢弃一个旧设备而未执行标准的撤销流程。攻击者获取该设备后，可以利用其未失效的密钥继续访问网络。
    *   **解决方案**: 协议 **MUST** 实现强制性的设备撤销机制（见3.2节）。通过广播撤销通知，确保网络中的所有其他成员都删除了与旧设备的信任关系，从而使旧密钥失效。

*   **重放攻击 (Replay Attacks)**
    *   **威胁**: 攻击者截获一条加密消息并稍后重传。
    *   **解决方案**: `vodozemac`实现的双棘轮算法内置了基于消息计数器的重放保护机制。接收方会拒绝处理任何序号重复或过时的消息。

### **7. 参考文献**

*   RFC 2119: Key words for use in RFCs to Indicate Requirement Levels.
*   The Double Ratchet Algorithm Specification (Informative).
*   The `vodozemac` library documentation (Normative).
*   MQTT Version 5.0 Specification (Informative).

[1] https://ppl-ai-file-upload.s3.amazonaws.com/web/direct-files/attachments/13804763/5478250d-7e58-4ea3-a7a6-e27ec6d8c88b/Personal-Trusted-Mesh-Base-Layer-Protocol.pdf