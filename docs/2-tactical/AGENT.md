# 2-tactical/AGENT.md（最终版 · 目录规则 · 以“文件”为单位）

目标
- 在每个限定上下文（bounded context）内，明确战术设计的最小可读集：领域模型（聚合/实体/值对象/不变量/事务边界）、用例（主流程与异常/边界）、领域事件（语义与发布订阅），并为交付契约提供直接映射入口。
- 协作节奏以“文件”为单位：先整文件初稿，再逐章/逐条修订；复杂上下文或内容膨胀时，新增同构文件进行分解。

目录结构建议
- 2-tactical/
  - AGENT.md（本规则文件）
  - bounded-contexts/
    - <context-name>/
      - AGENT.md（上下文内规则，可复制“子目录规则”段落）
      - domain-model.md
      - use-cases.md
      - events.md

文件清单（每个上下文内）
- domain-model.md：聚合/实体/值对象与不变量、事务边界、外部交互（命令/事件）。
- use-cases.md：关键用例清单，每条包含前置、主流程、异常、边界、结果。
- events.md：领域事件清单，每条包含名称、业务含义、触发、订阅、幂等/顺序性关注点（如适用）。

文件级结果契约与节奏
- domain-model.md
  - 结构
    - 标题与上下文名
    - Aggregates：按聚合分节
      - 每个聚合包含：职责（一句话）/ 不变量（≥1）/ 事务边界（何时需要一致性）/ 外部交互（命令/事件）
    - Entities：列出关键实体（字段只需关键属性）
    - Value Objects：列出值对象（不变性/等值性特征）
    - 可选：跨聚合协作注意点（若有）
  - 节奏
    - 首轮：整文件初稿（至少1个聚合完整小节+实体/值对象粗纲）
    - 迭代：逐“聚合小节”修订；每轮仅改一个聚合小节
  - 质量性质
    - 每个聚合至少1条不变量
    - 事务边界明确且与用例一致
    - 外部交互与 events.md 能互相映射

- use-cases.md
  - 结构（每条用例）
    - 用例ID/名称
    - 前置
    - 主流程（分步要点即可）
    - 异常（≥2条）
    - 边界（输入/并发/容量等）
    - 结果（状态/可观测信号占位）
    - 归属聚合（单一聚合优先；跨聚合需注明原因）
  - 节奏
    - 首轮：整文件初稿（3–5条关键用例骨架，主流程与至少1个异常填充）
    - 迭代：逐“用例章节”补齐异常/边界/结果；每轮仅改一个用例章节
  - 质量性质
    - 每条用例≥2个异常、≥1个边界
    - 结果可追溯到领域事件或契约变更
    - 归属聚合明确；跨聚合要有必要性说明

- events.md
  - 结构（每个事件）
    - 名称
    - 业务含义（一句话）
    - 触发时机（由谁、何时发布）
    - 订阅方示例（上下文名/职责）
    - 幂等或顺序性关注点（如适用）
  - 节奏
    - 首轮：整文件初稿（2–3个关键事件）
    - 迭代：逐“事件条目”深化（补幂等/顺序关注点/订阅方）
  - 质量性质
    - 事件命名使用通用语言
    - 可从用例或聚合行为推导其触发时机
    - 至少1个事件跨上下文被订阅（若该上下文承担集成）

抽象验收性质（DoD-Properties）
- 一致性：术语与 0-governance/glossary.md 对齐；与 1-strategic/context-map.md 的关系策略不冲突（同步/异步/ACL/防腐层）。
- 完备性（就当前阶段）：domain-model 至少1个聚合完整小节；use-cases 至少3条；events 至少2条。
- 可证伪性：聚合不变量可被挑战（给出易破坏的前提）；用例异常覆盖高频失败模式；事件给出幂等/顺序性边界假设。
- 可操作性：用例的结果与 4-delivery/contracts.md 的接口/事件有可映射提示；聚合外部交互可映射到 events.md。

对话节奏（内嵌规则）
- 初稿阶段：对每个文件单独生成“整文件初稿”，严格按本文件结构输出，仅含该文件内容，并在文末追加“## 变更”首条“v1.0 首版”。
- 修订阶段：每轮仅修改一个章节（聚合小节/用例章节/事件条目）；在指令中粘贴被修改段落原文，模型仅输出该段更新版。
- 扩展阶段（拆分）：当文件>150–200行或跨多个上下文/聚合导致内聚性下降时：
  - 按聚合或主题拆分为 domain-model-<aggregate>.md、use-cases-<theme>.md、events-<theme>.md
  - 原文件保留“参见”占位；新文件“## 变更”首条注明“从旧文件迁移”

与其他目录的对齐提示
- 与 0-governance：新增术语或约束要求时，先回填 governance，再继续战术修订，确保语言与限制先行。
- 与 1-strategic：用例与上下文关系保持一致；若策略从同步改异步，及时在 events.md 增补事件。
- 与 3-quality：重要用例与聚合决策需参考 scenarios.md 的性能/可靠/安全卡；必要时在用例“结果”加入可观测信号提示。
- 与 4-delivery：用例→接口/事件的映射建议写入 use-cases.md 结果段，便于在 contracts.md 直接落点。

文件顶端契约注释（建议复制到每个文件开头）
- domain-model.md
  - 本文件按章节维护聚合/实体/值对象；每个聚合小节包含职责/不变量/事务边界/外部交互。
  - 节奏：先整文件初稿（至少1个聚合完整小节），后逐“聚合小节”修订；每轮仅改一个小节；仅输出该小节。
  - 变更：仅在文末“## 变更”追加摘要。

- use-cases.md
  - 每条用例=前置/主流程/异常(≥2)/边界/结果/归属聚合。
  - 节奏：先整文件初稿（3–5条用例骨架），后逐“用例章节”补齐；每轮仅改一个章节；仅输出该章节。
  - 变更：仅在文末“## 变更”追加摘要。

- events.md
  - 每个事件=名称/含义/触发/订阅/幂等或顺序关注点(如适用)。
  - 节奏：先整文件初稿（2–3个事件），后逐“事件条目”深化；每轮仅改一个条目；仅输出该条目。
  - 变更：仅在文末“## 变更”追加摘要。

---

示例文件壳（可直接放入任一上下文子目录）

- domain-model.md
  # Domain Model - <context-name>

  ## Aggregates
  ### <AggregateName>
  职责：一句话
  不变量：
  - …
  - …
  事务边界：需要跨实体一致性的边界说明
  外部交互：命令/事件名（仅列名）

  ## Entities
  - <EntityName>(关键属性…)

  ## Value Objects
  - <ValueObjectName>(等值性/不变性说明)

  ## 变更
  - [v1.0 - YYYY-MM-DD] 首版

- use-cases.md
  # Use Cases - <context-name>
  - <UC-ID> <用例名称>
    前置：…
    主流程：步骤要点…
    异常：A…；B…
    边界：输入范围/并发/容量…
    结果：状态变化/可观测信号占位（如 order_create_latency）
    归属聚合：<AggregateName>

  - <UC-ID> …

  ## 变更
  - [v1.0 - YYYY-MM-DD] 首版

- events.md
  # Domain Events - <context-name>
  - <EventName> 含义：一句话 触发：由谁、何时发布 订阅：示例上下文/职责 幂等/顺序：若适用，说明约束或策略
  - <EventName> …

  ## 变更
  - [v1.0 - YYYY-MM-DD] 首版


- 子目录规则（复制到 2-tactical/bounded-contexts/<context>/AGENT.md）
  # Tactical Agent - <context-name> (Final · File-first)

  目标
  - 在 <context-name> 上下文内，以文件为单位产出并迭代 domain-model.md / use-cases.md / events.md，确保与治理/战略对齐，并为交付契约提供直达映射。

  文件清单
  - domain-model.md / use-cases.md / events.md（见上级目录规则的文件契约）

---

对话节奏
- 初稿：依次生成三个文件的整文件初稿（注意：仅输出目标文件内容）。
- 修订：每轮仅改一个聚合小节/用例章节/事件条目；指令中粘贴原段落，模型仅返回该段修订版。
- 扩展：当内容膨胀或主题分叉，按聚合/主题拆分文件（domain-model-Order.md、use-cases-create.md 等）。

对齐提示
- 术语/约束变化先回到 0-governance 补卡；上下文关系变化参考 1-strategic/context-map；性能/可靠等要求参考 3-quality/scenarios。
