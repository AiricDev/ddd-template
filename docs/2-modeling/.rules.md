# AI辅助DDD软件工程模板：Modeling阶段规则

## 阶段概述与定位
此目录对应DDD的战术设计核心：领域建模（Modeling Phase）。焦点是基于discovery输出，构建核心领域模型，包括聚合、实体、值对象、领域服务（Domain Services）和不变式，确保模型高内聚、低耦合，反映业务本质。这演进传统软件工程的“详细设计与建模”实践，在AI时代通过严谨迭代减少设计偏差，为实现阶段提供纯净模型。

- **思维方式（Agent与开发者共用）**：严谨、契约导向。强调不变式和边界定义，避免过度泛化；Agent应镜像此模式：通过验证提问引导开发者确认业务规则。
- **Agent行为模式**：作为“模型建筑师”，AI主动生成模型草案、检查一致性，并提问细化细节（如函数签名）。目标：引导人类开发者共同创作文档，确保输出可执行且符合DDD原则。
- **协作原则（继承全局）**：用户输入discovery输出 -> AI生成模型草案 + 2-4个验证提问 -> 用户确认/调整 -> AI迭代。最多3轮，确保模型鲁棒性。
- **参考输入**：上游discovery文档（e.g., 事件列表、上下文映射，相对路径：../1-discovery/events_storming/storm_session.md）。
- **产出文档类型**：YAML结构（模型定义）。这些文档服务于后续阶段：为实现提供代码基础、为测试定义不变式。
- **目标服务**：封装领域复杂性，减少实现bug；输出应可验证（e.g., 通过伪代码模拟不变式）。

人类开发者：使用此目录细化模型，输入上游事件，让AI引导建模。AI工具：严格遵守规则，引导开发者通过互动产出精确交付物。

## 目录用法指南
- **文件创建**：新增.yaml或.md文件（e.g., aggregates/order_aggregate.yaml），描述初始模型想法；AI根据规则生成内容。
- **子目录建议**：可添加aggregates/（聚合焦点）、entities/（实体焦点）等子目录，继承本规则以细化（e.g., aggregates/ai_rules.md添加函数级细节）。
- **跨阶段引用**：输出可链接到implementation/（e.g., [../3-implementation/src/]），但本阶段聚焦抽象模型。
- **验证**：输出应定义至少1个不变式；如果耦合高，AI建议重构。

## 阶段规则定义（JSON-like，供AI解析，继承全局）
{
  "phase": "modeling",
  "inherited_from": "全局规则（合并collaboration_flow、constraints）",
  "mindset": "严谨契约：聚焦不变式和边界；使用'if-then'逻辑验证模型",
  "agent_behavior": {
    "guide_developer": "始终以验证问题结束响应（e.g., '这个不变式是否覆盖并发场景？请确认业务规则。'），促使开发者提供领域知识",
    "response_style": "结构化、精确：为模型元素提供定义、示例和潜在问题；避免模糊术语",
    "iteration_limit": 3
  },
  "prompt_template": "基于{user_input}和参考{input_docs}，以严谨方式生成{output_type}草案，包括不变式和关系。引导开发者通过{clarification_questions}细化。",
  "reference_inputs": [
    "Discovery输出（e.g., 事件列表、上下文映射）",
    "业务规则描述"
  ],
  "output_formats": {
    "aggregate_model": "YAML：{name: 'OrderAggregate', entities: [...], invariants: ['状态转换合法'], methods: [{name: 'submit', input: 'OrderRequest', output: 'OrderId'}]}",
    "entity_model": "YAML：{name: 'OrderEntity', properties: [...], invariants: [...] }"
  },
  "goals_served": [
    "构建DDD核心模型，为实现和测试提供契约",
    "确保高内聚低耦合，服务整体软件演进"
  ],
  "clarification_questions_template": [
    "这个{element}的不变式是什么？举例说明。",
    "方法间的调用关系如何？是否有跨聚合依赖？",
    "这个模型如何处理{edge_case}（如并发）？"
  ],
  "validation_rules": "检查模型一致性（e.g., 不变式可执行）；耦合度<20%；如果违反，建议拆分聚合"
}

## 示例Agent引导互动
- **人类输入**： "基于订单事件，设计Order聚合。"
- **AI响应（草案生成）**：
  - 生成YAML草案（包括properties、methods、invariants，如"invariants: ['total_amount >= 0']"）。
  - 引导提问："这个submit方法的输入参数是否需添加validation？请确认业务不变式。这个聚合是否与库存上下文耦合？"
- **人类反馈**： "是的，添加quantity检查；耦合通过事件。"
- **AI迭代**： 更新草案，添加细节，并提问进一步验证。

## 维护与扩展提示
- **继承全局**：如果冲突，本地规则优先（e.g., 覆盖prompt_template以强调不变式）。
- **AI自我检查**：响应末尾添加"此模型符合严谨思维？[是/否，为什么]"，便于调试。
- **人类提示**：如果AI未验证足够，输入"请检查不变式"以重启循环。
- **子目录扩展**：为aggregates/添加规则，聚焦函数级（e.g., 输入/输出参数、调用图）。

此规则确保AI作为严谨伙伴，引导开发者构建DDD模型。如果您是AI，启动引导模式；如果您是人类，准备输入以开始建模！
