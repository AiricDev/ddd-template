# AI辅助DDD软件工程模板：Testing阶段规则

## 阶段概述与定位
此目录对应DDD的测试与验证阶段：确保领域模型和实现符合业务规则（Testing Phase）。焦点是基于implementation输出，生成单元/集成测试，验证聚合不变式、事件处理和边界一致性。这演进传统软件工程的“TDD/BDD实践”，在AI时代通过自动化生成提升覆盖率，减少手动测试债务。

- **思维方式（Agent专用）**：批判、覆盖导向。在生成前，进行chain-of-thought规划：判断测试类型（单元 vs. 集成）、覆盖范围（happy path、edges、不变式），确保DDD焦点（如聚合边界无泄漏）。
- **Agent行为模式**：直接执行测试生成任务：1. 分析输入并规划测试套件；2. 生成测试代码；3. 自验证覆盖。无人类引导循环——如果不确定，输出假设并标记；严格约束：测试隔离领域逻辑，模拟DDD事件。
- **协作原则（继承全局，调整为AI自治）**：AI基于输入直接生成，无迭代；输出包括预规划，确保可执行。
- **参考输入**：上游implementation代码/BDD spec（相对路径：../3-implementation/src/order_service.py）；modeling模型。
- **产出文档类型**：测试文件（e.g., .py）、报告（.md）。这些文档服务于evolution阶段：提供回归基础。
- **目标服务**：验证DDD不变式和行为，维护模型完整性；输出应覆盖>80%（e.g., 通过mutation testing）。

人类开发者：使用此目录触发AI生成测试，提供上游输入；运行并审阅输出。AI工具：严格遵守规则，直接执行任务，确保批判验证。

## 目录用法指南
- **文件创建**：新增测试文件（e.g., unit_tests/order_aggregate_test.py），AI根据规则填充。
- **子目录建议**：可添加unit_tests/（领域隔离）、integration_tests/（边界），继承本规则以细化（e.g., unit_tests/ai_rules.md强调不变式）。
- **跨阶段引用**：输出可链接到evolution/（e.g., [../5-evolution/reports/]），但本阶段聚焦验证。
- **验证**：测试必须失败于不变式违反；如果覆盖低，AI自拒并建议扩展。

## 阶段规则定义（JSON-like，供AI解析，继承全局）
{
  "phase": "testing",
  "inherited_from": "全局规则（合并constraints、output_format_defaults）",
  "mindset": "批判覆盖：判断测试类型（单元: 领域逻辑；集成: 边界）；先规划覆盖（invariants、edges），后生成",
  "agent_behavior": {
    "execution_mode": "自治生成：无引导；输出结构：1. 测试规划；2. 生成测试；3. 自验证报告",
    "pre_generation_step": "Chain-of-thought：指定类型（e.g., '单元测试OrderEntity不变式'），覆盖DDD事件/规则",
    "constraints": [
      "DDD测试：聚焦聚合边界、不变式（e.g., mock外部，测试纯领域）",
      "Clean Architecture契合：内层测试独立；使用BDD for行为验证",
      "全面性：包括happy path、failures、并发模拟"
    ],
    "response_style": "可执行、注释丰富：框架默认pytest/BDD；语言Python"
  },
  "prompt_template": "基于{user_input}和参考{input_docs}，生成{output_type}：先规划覆盖，然后创建测试，遵守DDD测试要求。",
  "reference_inputs": [
    "Implementation代码/spec",
    "Modeling不变式/模型"
  ],
  "output_formats": {
    "unit_test": "Python：import pytest\nclass TestOrderEntity: ...",
    "bdd_test": "Gherkin + Steps：Scenario: ... \ndef step_impl(context): ..."
  },
  "goals_served": [
    "验证DDD模型行为，确保不变式和边界",
    "服务演进：提供自动化回归套件"
  ],
  "validation_rules": "自检查：覆盖率>80%；不变式测试完整；如果失败，输出'无效：{reason}'"
}

## 示例Agent执行输出
- **人类输入**： "基于OrderEntity，实现单元测试。"
- **AI响应（直接生成）**：
  1. **测试规划**：
     - 类型：单元（隔离Entities）。
     - 覆盖：不变式（status valid）、edges（invalid input）、DDD事件（状态转换）。
     - 边界：Mock外部，无DB。
  2. **生成测试**（e.g., test_order_entity.py）：
     ```
     import pytest
     from domain.entities import OrderEntity  # From Entities layer

     class TestOrderEntity:
         def test_valid_invariant(self):
             order = OrderEntity("123", "Pending")
             assert order.status == "Pending"  # Happy path

         def test_invalid_invariant(self):
             with pytest.raises(ValueError):
                 OrderEntity("123", "Invalid")  # Edge: Violates invariant
     ```
  3. **自验证报告**： "覆盖不变式和edges；符合DDD：纯领域测试，无外部依赖。覆盖率估算90%."

## 维护与扩展提示
- **继承全局**：如果冲突，本地规则优先（e.g., 覆盖框架）。
- **AI自我检查**：输出末尾添加"此测试覆盖DDD要求？[是/否，为什么]"。
- **人类提示**：如果需要扩展，输入"添加{scenario}"；运行测试以验证。
- **子目录扩展**：为integration_tests/添加规则，聚焦边界（e.g., 事件集成）。

此规则确保AI自治生成DDD兼容测试。如果您是AI，启动执行模式；如果您是人类，准备输入以触发生成！
